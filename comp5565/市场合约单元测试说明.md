# ✅ Unit Test Summary: Marketplace (市场合约单元测试总结)

该脚本专注于验证 `Marketplace` 合约的权限控制和核心业务逻辑，确保制造商、零售商和客户之间的产品流转和交易限制正确执行。

## 一、初始化与权限设置 (Setup & Authorization)

| 验证点 | 目标功能 | 关键结果 |
| :--- | :--- | :--- |
| **部署与隔离** | 部署 `Marketplace`、`Roles` 和 `ProductRegistry`，并使用 `MockWarrantyManager` 隔离保修逻辑。 | 成功部署所有合约，并确认合约间的相互引用设置正确。 |
| **角色与授权** | 授予 `MANUFACTURER_ROLE` 和 `RETAILER_ROLE`。 | 成功授权 `Marketplace` 合约，使其具备代表 Retailer 和 Customer 转移 NFT 的权限（通过 `setApprovalForAll`）。 |

## 二、零售商销售给客户 (Retailer Sale - `retailSaleToCustomer`)

这组测试验证了零售商向最终客户销售产品的流程和权限。

| 测试场景 | 目标功能 | 验证结果 |
| :--- | :--- | :--- |
| **权限控制 (负面)** | 非零售商尝试调用销售函数。 | ❌ 交易回退，提示 `"MP: Only Retailer can sell."`，确保角色限制有效。 |
| **所有权检查 (负面)** | 零售商尝试销售不属于自己的产品。 | ❌ 交易回退，确保只有产品所有者（零售商）才能发起销售。 |
| **保修独立性 (成功)** | 模拟保修无效，零售商依然进行销售。 | ✅ 销售成功，确认 `retailSaleToCustomer` **不检查**保修状态的有效性，符合业务逻辑（初始销售不应受保修过期影响）。 |
| **标准销售 (成功)** | 零售商成功将产品销售给客户。 | ✅ 所有权成功转移到客户地址。 |

## 三、客户转售 (Customer Resale - `customerResale`)

这组测试验证了客户将产品转售给下一位买家的流程和限制。

| 测试场景 | 目标功能 | 验证结果 |
| :--- | :--- | :--- |
| **所有权检查 (负面)** | 非当前产品所有者尝试发起转售。 | ❌ 交易回退，提示 `"MP: Only current owner can initiate resale."`，确保只有产品持有者可以发起转售。 |
| **保修有效时转售 (成功)** | 在产品保修有效时进行转售（解除限制后的核心测试）。 | ✅ **核心成功测试：** 转售成功，确认系统允许客户在保修期内自由转售产品。 |
| **保修失效时转售 (成功)** | 在产品保修失效时进行转售。 | ✅ 转售成功，确认转售流程不受保修状态影响。 |

## 四、零售商上架 (Retailer Listing - `listProductForSale`)

这组测试验证了零售商在市场合约中上架产品的功能和权限。

| 测试场景 | 目标功能 | 验证结果 |
| :--- | :--- | :--- |
| **权限控制 (负面)** | 非零售商尝试上架产品。 | ❌ 交易回退，提示 `"MP: Only Retailer can list."`，确保只有拥有 `RETAILER_ROLE` 的账户才能执行上架操作。 |
| **标准上架 (成功)** | 零售商成功上架产品。 | ✅ 交易成功，并正确触发 `ProductListed` 事件，事件参数中包含 `tokenId`、`LIST_PRICE` 和 `retailer.address`。 |