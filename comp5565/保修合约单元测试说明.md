# ✅ Unit Test Summary: WarrantyManager (保修管理单元测试总结)

该脚本专注于验证 `WarrantyManager` 合约的保修生命周期管理，包括发行、索赔流程、权限控制以及基于时间戳的动态状态转换。

## 一、初始化与权限设置 (Setup & Authorization)

| 验证点 | 目标功能 | 关键结果 |
| :--- | :--- | :--- |
| **依赖部署** | 部署 `WarrantyManager` 并使用 `MockProductRegistry` 模拟 NFT 所有权检查。 | 成功部署，并设置了所有依赖地址。 |
| **角色授予** | 授予 `MANUFACTURER_ROLE` 和 `SERVICECENTER_ROLE`。 | 确保只有授权的制造商和服务中心能够执行核心功能。 |

## 二、保修发行与初始状态 (Issuance)

| 测试场景 | 目标功能 | 验证结果 |
| :--- | :--- | :--- |
| **权限控制 (负面)** | 非制造商尝试调用 `issueWarranty`。 | ❌ 交易回退，提示 `"WM: Not Manufacturer or Marketplace"`，确保发行权限被限制。 |
| **标准发行 (成功)** | 制造商成功发行保修。 | ✅ 保修数据（时长、最大索赔次数）正确记录，初始状态为 `Active (1)`。 |

## 三、保修索赔流程 (Claim Flow)

这组测试验证了客户发起请求、服务中心处理请求和索赔次数追踪的完整流程。

| 测试场景 | 目标功能 | 验证结果 |
| :--- | :--- | :--- |
| **发起请求** | 客户发起服务请求（`requestService`）。 | ✅ 状态成功从 `Active (1)` 转换为 `Pending (2)`。 |
| **批准索赔** | 服务中心批准索赔（`approveClaim`）。 | ✅ 状态变回 `Active (1)`，**索赔次数** (`claimedCount`) 成功增加。 |
| **拒绝索赔** | 服务中心拒绝索赔（`rejectClaim`）。 | ✅ 状态变回 `Active (1)`，但**索赔次数**保持不变，确保拒绝不消耗索赔额度。 |
| **达到上限** | 连续批准索赔，直到达到 `maxClaims`。 | ✅ 状态成功转换为 `Fulfilled (4)`，表示保修责任已全部履行。 |

## 四、动态状态和限制 (Dynamic Status & Limits)

这组测试验证了合约基于时间戳判断保修状态的动态逻辑，以及状态的优先顺序。

| 测试场景 | 目标功能 | 验证结果 |
| :--- | :--- | :--- |
| **保修期内检查** | 模拟时间前进，但仍在保修期内。 | ✅ 状态保持 `Active (1)`。 |
| **时间过期检查** | 模拟时间推进超过保修时长。 | ✅ **核心动态验证：** 状态动态转换为 `Expired (3)`，且 `isWarrantyValid` 返回 `false`。 |
| **Fulfilled 状态优先** | 产品先达到最大索赔次数（`Fulfilled: 4`），然后时间过期。 | ✅ 状态保持为 `Fulfilled (4)`，证明 `Fulfilled` 状态的优先级高于时间过期，防止状态回退。 |