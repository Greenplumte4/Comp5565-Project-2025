# ✅ Unit Test Summary: ProductRegistry (产品注册表单元测试总结)

该脚本专注于验证 `ProductRegistry` (NFT 合约) 的核心功能，包括产品的铸造、静态数据存储，以及关键的产品所有权转让限制逻辑。

## 一、初始化与权限设置 (Setup & Authorization)

| 验证点 | 目标功能 | 关键结果 |
| :--- | :--- | :--- |
| **部署与依赖** | 部署 `ProductRegistry`，并传入 `RolesContract` 和 `MockWarrantyManager` 地址。 | 成功部署。使用 `MockWarrantyManager` 隔离保修逻辑，确保测试专注于注册表本身的逻辑。 |
| **Marketplace 授权** | 设置 `marketplaceMock` 地址。 | 成功设置，允许模拟的 `Marketplace` 账户调用受限的内部函数，如 `mintProduct`。 |

## 二、产品铸造 (NFT Minting - `mintProduct`)

这组测试验证了新产品 NFT 的发行流程，该流程仅应由 `Marketplace` 触发。

| 测试场景 | 目标功能 | 验证结果 |
| :--- | :--- | :--- |
| **权限控制 (负面)** | 非 `Marketplace` 地址尝试调用 `mintProduct`。 | ❌ 交易回退，提示 `"Registry: Only Marketplace can call."`，确保铸造权限仅限于 `Marketplace`。 |
| **标准铸造 (成功)** | `Marketplace` 成功铸造新产品。 | ✅ 成功触发 `Transfer` 事件 (从 `address(0)` 转移)，验证产品静态数据（如序列号）正确存储，所有权正确分配。 |
| **代币 ID 递增 (成功)** | 连续铸造新产品。 | ✅ 验证新产品的代币 ID 自动递增，符合 ERC721 规范。 |

## 三、产品转让限制 (Transfer Restrictions - `transferFrom` / `restrictedTransferFrom`)

这组测试验证了不同角色之间转让产品 NFT 的业务逻辑。

| 测试场景 | 目标功能 | 验证结果 |
| :--- | :--- | :--- |
| **客户 -> 零售商** | 客户将产品转移给零售商（例如退货或回购）。 | ✅ 转让成功，业务角色间的基础转账被允许。 |
| **零售商 -> 客户** | 零售商将产品转移给客户（例如销售）。 | ✅ 转让成功，业务角色间的基础转账被允许。 |
| **客户 -> 客户 (保修有效)** | 客户之间转售产品，保修状态为有效。 | ✅ **核心成功测试：** 转让成功，确认产品注册表中的限制已解除，允许客户在保修期内自由转让。 |
| **客户 -> 客户 (保修失效)** | 客户之间转售产品，保修状态为失效。 | ✅ 转让成功，进一步确认客户间的转让不再受保修状态的限制。 |

## 四、特殊转让：授权人/操作者 (Approved / Operator)

这组测试验证了通过 `approve` 或 `setApprovalForAll` 授权给第三方地址（例如 `Marketplace`）进行转让的逻辑。

| 测试场景 | 目标功能 | 验证结果 |
| :--- | :--- | :--- |
| **授权人转让 (保修失效)** | 被授权地址（`user`）在保修失效时进行转让。 | ✅ 转让成功，ERC721 的授权机制在保修失效时工作正常。 |
| **授权人转让 (保修有效)** | 被授权地址在保修有效时进行转让。 | ✅ **核心成功测试：** 转让成功，确认即使有第三方授权人代为转让（例如 `Marketplace` 执行客户转售），也不会因保修有效性而被阻止。 |