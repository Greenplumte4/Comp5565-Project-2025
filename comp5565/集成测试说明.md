# 🚀 系统集成测试总结：产品生命周期与保修 (Integration Test Summary)


## 一、系统初始化与合约协作验证 (Setup & Linking)

| 测试点 | 目标功能 | 验证结果 |
| :--- | :--- | :--- |
| **1. 合约部署与链接** | 验证所有核心合约的成功部署和相互地址引用设置（Setter）。 | ✅ 成功部署并确认合约间的相互地址链接正确。 |
| **2. 角色授予与授权** | 验证管理员角色的授予，以及核心业务角色的权限设置。 | ✅ 角色授予成功。**关键验证：** 确认零售商和客户通过 `setApprovalForAll` 授权 Marketplace 合约，具备代理转移 NFT 的权限。 |

## 二、产品生命周期追踪 (Product Lifecycle Traceability)

| 测试点 | 目标功能 | 验证结果 |
| :--- | :--- | :--- |
| **3. 制造商初始分发** | 测试制造商通过 `Marketplace` 注册新产品并首次分发给零售商（`registerAndDistribute`）。 | ✅ 所有权从 0x0 成功转移到 Retailer。保修同时发行。溯源历史记录中新增 `INITIAL_DISTRIBUTION` 事件。 |
| **4. 零售商销售给客户** | 测试零售商将产品销售给客户（`retailSaleToCustomer`）。 | ✅ 所有权成功从 Retailer 转移到 Customer1。溯源历史记录中新增 `RETAIL_SALE` 事件。 |
| **6A. 客户转售** | 测试客户在保修有效期间转售产品（`customerResale`）。 | ✅ **关键成功测试：** 确认保修有效时，客户转售操作成功执行，产品所有权转移，历史记录新增 `CUSTOMER_RESALE` 事件。 |

## 三、保修索赔与状态管理 (Warranty Claim Flow)

| 测试点 | 目标功能 | 验证结果 |
| :--- | :--- | :--- |
| **5. 客户发起请求** | 客户发起服务请求（`requestService`）。 | ✅ 保修状态从 `Active (1)` 成功转换为 `Pending (2)`。 |
| **5. 服务中心拒绝** | 服务中心拒绝索赔（`rejectClaim`）。 | ✅ 状态从 `Pending (2)` 变回 `Active (1)`，且索赔计数 (`claimedCount`) 保持不变。 |
| **5. 服务中心批准** | 服务中心批准索赔（`approveClaim`）。 | ✅ 状态从 `Pending (2)` 变回 `Active (1)`，且索赔计数成功增加（到 1）。 |

## 四、权限与限制（负面测试）(Negative & Restriction Tests)

| 测试点 | 目标功能 | 验证结果 |
| :--- | :--- | :--- |
| **5. 非授权批准** | **权限负面测试：** 验证非服务中心尝试调用 `approveClaim`。 | ❌ 交易回退 (`Reverted`)，确保权限控制有效。 |
| **6B. 达到最大索赔次数** | **业务逻辑限制：** 验证当索赔次数达到上限（`maxClaims=1`）后，客户无法发起新的服务请求。 | ❌ 交易回退，返回特定的错误信息 `"Maximum claims reached."`，证明 `Fulfilled (4)` 状态的锁定机制有效。 |

## 五、动态状态验证 (Dynamic State Check)

| 测试点 | 目标功能 | 验证结果 |
| :--- | :--- | :--- |
| **6C. 时间过期** | **时间依赖验证：** 模拟区块链时间前进超过保修期。 | ✅ `getWarrantyStatus` 动态返回 `Expired (3)`，且 `isWarrantyValid` 返回 `false`，证明保修管理器能正确处理基于时间的状态转换。 |

